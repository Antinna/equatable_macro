name: Update Changelog

on:
  push:
    branches:
      - master
      # - main
      # - stable

  pull_request:
    branches:
      - master
      # - main
      # - stable
permissions:
  contents: write
jobs:
  update-changelog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: 🎯 Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: dev

      - name: 📦 Install Dependencies
        run: dart pub get

      #   - name: 🔍 Analyze
      #     run: dart --enable-experiment=macros analyze --fatal-infos
      #   - name: 💅 Format Code
      #     run: dart format --output=none --set-exit-if-changed .

      - name: 🧪 Run Test
        # TODO: move to dart test when macro feature support is stable
        run: dart --enable-experiment=macros test

      - name: Set up Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Get latest commit message
        id: get_commit_message
        run: |
          echo "::set-output name=message::$(git log -1 --pretty=%B)"

      - name: Update Changelog
        run: |
          chmod +x scripts/update_changelog.sh
          ./scripts/update_changelog.sh "${{ steps.get_commit_message.outputs.message }}"

      - name: Commit changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add CHANGELOG.md
          git commit -m "Update CHANGELOG.md with latest commit message"
          git push
